package com.beamstream
package model

import locs.Sitemap

import org.joda.time.DateTime

import net.liftweb._
import common._
import http._
import mongodb.record._
import mongodb.record.field._

import org.bson.types.ObjectId

class LoginToken extends MongoRecord[LoginToken] with ObjectIdPk[LoginToken] {
  def meta = LoginToken

  object userId extends ObjectIdRefField(this, User)
  object expires extends DateField(this) {
    override def defaultValue = ((new DateTime).plusHours(48)).toDate
  }

  def authLink = S.hostAndPath+"/auth?token="+id.toString
}
object LoginToken extends LoginToken with MongoMetaRecord[LoginToken] with Loggable {
  override def collectionName = "user.authtokens"

  def createForUserId(uid: ObjectId): LoginToken = createRecord.userId(uid).save

  def deleteAllByUserId(userId: ObjectId) {
    logger.debug("Deleting all LoginTokens for userId: %s".format(userId.toString))
    delete("userId", userId)
  }

  def handleToken: Box[LiftResponse] = {
    var retVar = RedirectResponse(Sitemap.homeLoc.url)
    S.param("token") match {
      case Full(t) if (ObjectId.isValid(t)) => find(new ObjectId(t)) match {
        case Full(at) if ((new DateTime).getMillis >= (new DateTime(at.expires.value)).getMillis) => {
          S.error("Auth token has expired.")
          at.delete_!
        }
        case Full(at) => {
          at.userId.obj match {
            case Full(u) => {
              u.verified(true)
              u.save
              at.delete_!

              retVar = RedirectResponse("/set_password") // need new transition page to allow user to select to set a password and/or to "remember me"
            }
            case _ => S.error("User not found.")
          }
        }
        case _ => S.error("Invalid auth token.")
      }
      case _ => S.warning("Auth token not provided.")
    }

    Full(retVar)
  }
}
